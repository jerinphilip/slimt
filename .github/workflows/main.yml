name: "main"
on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  pull_request:
    branches:
      - '**'

jobs:
  formatting:
      name: "format"
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2
          with:
            submodules: recursive

        - name: Install dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y build-essential cmake
            sudo apt-get install -y clang-format clang-tidy
            python3 -m pip install black isort
            python3 -m pip install cmake-format
            sudo apt-get install -y shfmt

        - name: Run format-script
          run:
            bash scripts/ci/format-check.sh

  build-test:
      name: "build-test"
      strategy:
        fail-fast: false
        matrix:
          include:
            - name: "ubuntu"
              os: "ubuntu-latest"
            - name: "macos"
              os: "macos-latest"
            - name: "android"
              os: "ubuntu-latest"

      runs-on: ${{ matrix.os }}

      steps:
        - name: Checkout
          uses: actions/checkout@v2
          with:
            submodules: recursive

        - name: Install dependencies
          run: |
            bash scripts/ci/${{ matrix.tag }}/01-setup.sh

        - name: Build
          run:
            bash scripts/ci/${{ matrix.tag }}/02-build.sh

        - name: Test
          run:
            bash scripts/ci/${{ matrix.tag }}/03-test.sh
